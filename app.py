# -*- coding: utf-8 -*-
"""M√©moire VF 13juin.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1c-MV9U2ROPR3D9ZkWtNq5HLuJjnye7ZJ
"""

import streamlit as st
import pandas as pd
import random
import json
import gspread
from google.oauth2.service_account import Credentials

# FONCTION D'EXPORT GOOGLE SHEETS (via secrets Streamlit Cloud)

def enregistrer_donnees_google_sheet(donnees_dict):
    scopes = ["https://www.googleapis.com/auth/spreadsheets",
          "https://www.googleapis.com/auth/drive"]

    # R√©cup√©ration s√©curis√©e depuis les secrets de Streamlit Cloud
    creds = Credentials.from_service_account_info(
        json.loads(st.secrets["GOOGLE_SERVICE_ACCOUNT"]),
        scopes=scopes
    )

    client = gspread.authorize(creds)
    sheet = client.open("Exp√©rimentation_Transparence_IA").worksheet("R√©ponses")

    colonnes = [
        "groupe", "produit_choisi",
        "confiance", "comprehension", "experience", "aisance_IA",
        "comprehension_post", "fiabilite", "equite", "intention"
    ]
    ligne = [donnees_dict.get(col, "") for col in colonnes]
    sheet.append_row(ligne)

# INITIALISATION

if "page" not in st.session_state:
    st.session_state.page = "accueil"

# PAGE 1 : ACCUEIL ‚Äì Version professionnelle

if st.session_state.page == "accueil":
    st.image("https://images.unsplash.com/photo-1581092919535-5fe179f39547", use_column_width=True)

    st.title("üß† Exp√©rimentation : Recommandations et Transparence")

    st.markdown("""
    Bienvenue et merci pour votre participation.

    Dans le cadre de notre m√©moire de recherche, nous r√©alisons une √©tude sur la transparence des syst√®mes de recommandation utilisant l‚Äôintelligence artificielle.

    Vous serez invit√©(e) √† interagir avec une interface simul√©e de type e-commerce, au sein de laquelle diff√©rents produits vous seront sugg√©r√©s.
    L‚Äôobjectif est d‚Äôanalyser comment le niveau de transparence algorithmique peut influencer la confiance des utilisateurs et leurs d√©cisions.

    Toutes les r√©ponses sont strictement anonymes et exploit√©es uniquement √† des fins de recherche acad√©mique.
    La participation est volontaire, et il est possible d‚Äôinterrompre l‚Äôexp√©rimentation √† tout moment.

    En cliquant sur le bouton ci-dessous, vous acceptez de participer √† cette √©tude.
    """)

    if st.button("Commencer l‚Äôexp√©rimentation"):
        st.session_state.page = "questionnaire_pre"

# PAGE 2 : QUESTIONNAIRE PR√â-EXPOSITION

elif st.session_state.page == "questionnaire_pre":
    st.subheader("√âtape 2 sur 4 : Questionnaire initial")

    st.markdown("""
    Merci de r√©pondre aux affirmations suivantes en indiquant votre degr√© d‚Äôaccord (1 = Pas du tout d‚Äôaccord, 5 = Tout √† fait d‚Äôaccord).

    Ces questions visent √† mieux comprendre votre perception des syst√®mes de recommandation **avant** l‚Äôexp√©rimentation.
    """)

    st.markdown("---")

    st.markdown("**Je fais confiance aux recommandations propos√©es par les plateformes en ligne.**")
    q1 = st.slider("", 1, 5, 3)

    st.markdown("**Je comprends en g√©n√©ral comment ces recommandations sont g√©n√©r√©es.**")
    q2 = st.slider("", 1, 5, 3)

    st.markdown("**J‚Äôai d√©j√† eu de bonnes exp√©riences avec des recommandations personnalis√©es.**")
    q3 = st.slider("", 1, 5, 3)

    st.markdown("**Je suis √† l‚Äôaise avec l‚Äôusage de l‚Äôintelligence artificielle dans le e-commerce.**")
    q4 = st.slider("", 1, 5, 3)

    st.markdown("---")

    if st.button("Passer √† l‚Äôexp√©rience"):
        st.session_state.q_pre = {
            "confiance": q1,
            "comprehension": q2,
            "experience": q3,
            "aisance_IA": q4
        }
        st.session_state.page = "interface_reco"

# PAGE 3 : INTERFACE DE RECOMMANDATION

elif st.session_state.page == "interface_reco":
    st.header("Vos recommandations")

    if "groupe" not in st.session_state:
        st.session_state.groupe = random.choice(["faible", "moyenne", "elevee"])

    groupe = st.session_state.groupe
    st.subheader(f"Niveau de transparence : {groupe.capitalize()}")

    # Affichage contextuel du niveau de transparence
    if groupe == "faible":
        st.markdown("Voici une s√©lection de produits susceptibles de vous int√©resser.")
    elif groupe == "moyenne":
        st.markdown("Ces produits vous sont propos√©s en fonction de vos pr√©f√©rences g√©n√©rales (ex. : articles consult√©s r√©cemment, cat√©gories populaires).")
    elif groupe == "elevee":
        st.markdown("""
         Ces recommandations sont bas√©es sur plusieurs crit√®res :
        - Vos produits consult√©s r√©cemment
        - Les articles ajout√©s √† votre panier
        - Vos pr√©f√©rences d√©clar√©es lors de l‚Äôinscription

        Chaque suggestion est le r√©sultat d‚Äôune analyse de ces donn√©es via un algorithme explicable.
        """)
    # Simulation d‚Äôune liste de produits
     produits = {
        "Livre : 'L‚ÄôIA pour les nuls'": {
            "image": "https://images.unsplash.com/photo-1524995997946-a1c2e315a42f",
            "desc": "Un guide accessible pour comprendre l‚Äôintelligence artificielle et ses enjeux actuels."
        },
        "Casque Bluetooth": {
            "image": "https://images.unsplash.com/photo-1585386959984-a41552256d40",
            "desc": "Confort, autonomie et son immersif : id√©al pour √©couter vos contenus pr√©f√©r√©s."
        },
        "Abonnement streaming": {
            "image": "https://images.unsplash.com/photo-1581090700227-1e8a2b8c19ae",
            "desc": "Acc√®s illimit√© √† des milliers de films, s√©ries et documentaires en haute qualit√©."
        },
        "Lampe connect√©e": {
            "image": "https://images.unsplash.com/photo-1570051008600-b34baa49e751",
            "desc": "Personnalisez l‚Äôambiance de votre int√©rieur avec une lumi√®re intelligente et intuitive."
        }
    }

    selection = None
    cols = st.columns(2)

    for i, (nom, infos) in enumerate(produits.items()):
        with cols[i % 2]:
            st.image(infos["image"], caption=nom, use_column_width=True)
            st.markdown(f"**{infos['desc']}**")
            if st.button(f"S√©lectionner : {nom}"):
                selection = nom

    if selection:
        st.session_state.selection = selection
        st.session_state.page = "questionnaire_post"

# PAGE 4 : QUESTIONNAIRE POST-EXPOSITION ‚Äì Version enrichie

elif st.session_state.page == "questionnaire_post":
    st.subheader("√âtape 4 sur 4 : Questionnaire final")

    st.markdown("""
    Merci pour votre participation √† l‚Äôinteraction.

    Nous aimerions maintenant conna√Ætre votre ressenti √† propos des recommandations re√ßues.
    Merci d‚Äôindiquer dans quelle mesure vous √™tes d‚Äôaccord avec les affirmations suivantes
    (1 = Pas du tout d‚Äôaccord, 5 = Tout √† fait d‚Äôaccord).
    """)

    st.markdown("---")

    st.markdown("**1. Je comprends pourquoi ces produits m‚Äôont √©t√© recommand√©s.**")
    p1 = st.slider("", 1, 5, 3)

    st.markdown("**2. L‚Äôalgorithme me semble fiable et pertinent.**")
    p2 = st.slider("", 1, 5, 3)

    st.markdown("**3. Je consid√®re que les recommandations √©taient justes et √©quilibr√©es.**")
    p3 = st.slider("", 1, 5, 3)

    st.markdown("**4. Je serais pr√™t(e) √† utiliser ce type de syst√®me √† l‚Äôavenir.**")
    p4 = st.slider("", 1, 5, 3)

    st.markdown("---")

    if st.button("Terminer l‚Äô√©tude"):
        st.session_state.q_post = {
            "comprehension_post": p1,
            "fiabilite": p2,
            "equite": p3,
            "intention": p4
        }
        st.session_state.page = "fin"

# PAGE 5 : FIN + ENREGISTREMENT

elif st.session_state.page == "fin":
    st.header("Merci pour votre participation")

    st.markdown("""
    Votre contribution a bien √©t√© enregistr√©e.

    Nous vous remercions sinc√®rement d‚Äôavoir pris le temps de participer √† cette √©tude.
    Vos r√©ponses nous permettront d‚Äôapprofondir notre compr√©hension des liens entre transparence algorithmique, confiance des utilisateurs et efficacit√© des syst√®mes de recommandation.

    Vous pouvez √† pr√©sent fermer cette page.
    En cas de question ou si vous souhaitez √™tre inform√©(e) des r√©sultats de l‚Äô√©tude, n‚Äôh√©sitez pas √† nous contacter.
    """)

    # R√©cup√©ration des donn√©es √† sauvegarder
    donnees = {
        "groupe": st.session_state.groupe,
        "produit_choisi": st.session_state.selection,
        **st.session_state.q_pre,
        **st.session_state.q_post
    }

    try:
        enregistrer_donnees_google_sheet(donnees)
        st.success("‚úÖ Enregistrement r√©ussi.")
    except Exception as e:
        st.error(f"‚ùå Une erreur est survenue : {e}")